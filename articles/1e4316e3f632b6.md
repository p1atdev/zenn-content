---
title: "NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ Swift ã‹ã‚‰å‘¼ã³å‡ºã™"
emoji: "ğŸ§µ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["swift", "npm", "javascript", "javascriptcore", "webpack"]
published: true
---

JavaScriptCore ã¨ã„ã†ã‚‚ã®ã‚’ã”å­˜çŸ¥ã§ã—ã‚‡ã†ã‹ï¼Ÿ

JavaScriptCore ã¯ ç´”æ­£ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ ã“ã‚Œã‚’ä½¿ã†ã¨ Swift ã‚„ Objective-C ã‹ã‚‰ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
ã‚‚ã¡ã‚ã‚“ã€iOS ã‚¢ãƒ—ãƒªã‹ã‚‰ã§ã‚‚å®Ÿè¡Œã§ãã¾ã™

è©³ç´°: [JavaScriptCore | Apple Developer Documentation](https://developer.apple.com/documentation/javascriptcore)

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€Webpack ã§ JS ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒ³ãƒ‰ãƒ«ã—ã€ã“ã® JavaScriptCore ã§ Swift ã¨ JavaScript ã‚’é€£æºã™ã‚‹ã“ã¨ã§ã€Swift ã‹ã‚‰ NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é–“æ¥çš„ã«ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

## ãã‚‚ãã‚‚ãªãœ Swift ã‹ã‚‰ JavaScript ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ã®ã‹ï¼Ÿ

ä¸€ç•ªå¤§ããªç†ç”±ã¯ã‚„ã¯ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é‡ã®å·®ã§ã™ã€‚JS ã¨ Swift ã‚’æ¯”è¼ƒã™ã‚‹ã¨ã€åˆ©ç”¨è€…ã‚‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚åœ§å€’çš„ã« JS ã®æ–¹ãŒå¤šã„ã§ã™ã€‚
ãã®ãŸã‚ã€ç‰¹å®šã®ã“ã¨ã‚’ã—ãŸã„ã¨ã„ã†ã¨ãã«ã€Swift ã ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ãŸã‚è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€JS ã§ã‚ã‚Œã°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚‹ã€ã¨ã„ã†çŠ¶æ³ãŒãŸã¾ã«ç™ºç”Ÿã—ã¾ã™

ãã“ã§ã€JS ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ Swift ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã“ã¨ãŒã§ãã‚Œã°å®Ÿè£…ã®æ‰‹é–“ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™

# å®Ÿè£…

ä»Šå›ã¯ Swift ã‹ã‚‰ JavaScript ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ã€`lodash` ã‚’ä½¿ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã™

æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰
https://github.com/p1atdev/JSBridge

:::details ç­†è€…ã®ç’°å¢ƒ

macOS Ventura 13.0 Beta
Xcode 14.0.0. beta-2
Node 16.13.1
Yarn 1.22.19

:::

## å‰æçŸ¥è­˜

-   Swift ã®åŸºæœ¬æ–‡æ³•ã€SwiftUI ã®åŸºæœ¬çŸ¥è­˜
-   JavaScript ã®åŸºæœ¬çš„ãªçŸ¥è­˜
-   Webpack ã®é›°å›²æ°—

# Swift ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

Xcode ã‹ã‚‰æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™

![](/images/1e4316e3f632b6/new-project.png =500x)

ä»Šå›ã¯ Multiplatform ã® App ã‚’é¸æŠã—ã¾ã—ãŸãŒåˆ¥ã«ã©ã‚Œã§ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¾ã™

![](/images/1e4316e3f632b6/project-naming.png =640x)

`JSBridge` ã¨ã„ã†åå‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ

![](/images/1e4316e3f632b6/initial-swiftui.png =640x)

SwiftUI ã‚¢ãƒ—ãƒªã®åˆæœŸçŠ¶æ…‹ã§ã™

# JS ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

JS ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
ä»Šå›ã¯ã€å…ˆã»ã©ä½œæˆã—ãŸ `JSBridge` ãƒ•ã‚©ãƒ«ãƒ€ã®ç›´ä¸‹ã« `JS` ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ

![](/images/1e4316e3f632b6/directory.png =400x)

ã“ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ Xcode ã§ã¯ãªã VSCode ãªã©ã‚’ä½¿ã£ã¦ä½œæ¥­ã™ã‚‹ã¨è‰¯ã„ã§ã™

## `.gitignore` ã®è¨­å®š

å¾Œã€…`node_modules` ãƒ•ã‚©ãƒ«ãƒ€ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€å…ˆã«ãƒ«ãƒ¼ãƒˆã« `.gitignore` ã‚’ä½œæˆã—ã¦ãŠãã¾ã™

[gitignore.io](https://gitignore.io) ã§ç”Ÿæˆã™ã‚‹ã¨æ¥½ã§ã™

## `npm init`

`npm init -y` ã‚„ `yarn init -y` ãªã©ã‚’å®Ÿè¡Œã—ã¦ `package.json` ã‚’ç”Ÿæˆã—ã¾ã™

ä¾‹

```json:package.json
{
  "name": "bridge",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
}
```

# Webpack

JavaScriptCore ã§ã¯ã€JS ã‚³ãƒ¼ãƒ‰ã‚’æ–‡å­—åˆ—ã¨ã—ã¦å—ã‘å–ã£ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™
ãã®ãŸã‚ã€NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã¯ã€ä¸€ã¤ã®ã‚³ãƒ¼ãƒ‰ã«ã¾ã¨ã‚ã¦ã‚ã’ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™

ãã“ã§ä½¿ã†ã®ãŒã€ãŠé¦´æŸ“ã¿ã® webpack ã§ã™
Web ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã§ã¯ã»ã¼ webpack ãŒå‡ºã¦ãã¦ã€è¤‡æ•°ã® JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ³ãƒ‰ãƒ«ã—ãŸã‚Šã—ã¦ã„ã¾ã™
ã“ã“ã§ã‚‚ã€Web ã¨åŒã˜ã‚ˆã†ã«ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ã“ã¨ãŒç›®çš„ãªã®ã§ã€ã„ã¤ã‚‚ã¨åŒã˜ã‚ˆã†ã«ä½¿ã†ã“ã¨ã§è§£æ±ºã§ãã¾ã™

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash:npm
npm install -D webpack webpack-cli
```

ã¾ãŸã¯

```bash:yarn
yarn add -D webpack webpack-cli
```

ãƒ“ãƒ«ãƒ‰ã«ã—ã‹ä½¿ç”¨ã—ãªã„ãŸã‚ã€`-D` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ã€ãƒ“ãƒ«ãƒ‰æ™‚ã« Webpack è‡ªèº«ã‚’å«ã‚ã¦ç”Ÿæˆã—ãªã„ã‚ˆã†ã«ã—ã¾ã™

## è¨­å®š

`webpack.config.js` ã‚’ä½œæˆã—ã¾ã™
`webpack init` ã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†ã¨ã€ä½™è¨ˆãªã‚‚ã®ãŒå…¥ã£ã¦ãã‚‹ã®ã§è‡ªåˆ†ã§æ›¸ãã®ãŒãŠã™ã™ã‚ã§ã™

ã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã™

```js:webpack.config.js
var path = require("path")

module.exports = {
    entry: { Bridge: "./index.js" }, // ã“ã® `Bridge` ã¨ã„ã†åå‰ã¯è‡ªç”±ã«å¤‰ãˆã¦ã‚‚è‰¯ã„ã‘ã©ã‚ã¨ã§ä½¿ã†ã®ã§å¿˜ã‚Œãªã„ã‚ˆã†ã«
    output: {
        path: path.resolve(__dirname, "dist"),
        filename: "[name].bundle.js",
        library: "[name]",
        libraryTarget: "var",
    },
}
```

`package.json` ã®æ–¹ã«ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½è¨˜ã—ã¾ã™

```json:package.json
{
  "name": "bridge",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "dependencies": {
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "webpack": "^5.73.0",
    "webpack-cli": "^4.10.0"
  },
  "scripts": {
    "build": "webpack --progress --color"
  }
}
```

`build` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å„è‡ªè¦‹ã‚„ã™ã„ã‚ˆã†ã«å¤‰ãˆã¦è‰¯ã„ã¨æ€ã„ã¾ã™

ã“ã‚Œã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã§ã™

# NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å„è‡ªã®ä½¿ã„ãŸã„ NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

ãªã‚“ã§ã‚‚è‰¯ã„ã®ã§ã™ãŒã€ä»Šå›ã¯ `lodash` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸ
(å®Ÿéš›ã¯ã‚ã–ã‚ã– Swift ã‹ã‚‰ `lodash` ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã†ä¾¡å€¤ãªã‚“ã¦ãªã„ã§ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã†ã®ã§)

`lodash` ã¯ JS ç”¨ã®ä¾¿åˆ©é–¢æ•°è©°ã‚åˆã‚ã›ãƒ‘ãƒƒã‚¯ã¿ãŸã„ãªã‚‚ã®ã§ã™
`loadash` ã§ã¯ãªã„ã®ã§æ³¨æ„(ä¸€æ•—)

https://lodash.com/

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

```bash:npm
npm install lodash
```

ã¾ãŸã¯

```bash:yarn
yarn add lodash
```

ä»Šå›ã¯ `-D` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã¤ã‘ã¾ã›ã‚“

# JS å´ã®å®Ÿè£…

`index.js` ã‚’ä½œæˆã—ã€ã¾ãšã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã™
(ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€`webpack.config.js` ã§åˆã‚ã›ã‚Œã°ãªã‚“ã§ã‚‚ã„ã„ã¨æ€ã†)

```js:index.js
import * as lodash from "lodash"

// ã“ã®ã‚¯ãƒ©ã‚¹åã‚‚ã‚ã¨ã§ä½¿ã†ã“ã¨ã«ãªã‚‹
export class Bridge {
    // lodash ã®æ•°å­—ã®é…åˆ—ã®å’Œã‚’è¿”ã™é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—
    static sum(array) {
        return lodash.sum(array)
    }
}
```

ã‚³ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã€`Bridge` ã‚¯ãƒ©ã‚¹ã® `sum` ã¨ã„ã†é–¢æ•°ã§ `lodash` ã® `sum` ã‚’ãƒ©ãƒƒãƒ—ã—ã¦å‘¼ã³å‡ºã—ã¦ã„ã¾ã™

## ãƒãƒ³ãƒ‰ãƒ«

Webpack ã§ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™

```bash:npm
npm run build
```

ã¾ãŸã¯

```bash:yarn
yarn build
```

ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`dist` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ–°ãŸã«ä½œæˆã•ã‚Œã€ä¸­ã« `Bridge.bundle.js` ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™

![](/images/1e4316e3f632b6/bundled.png =400x)

`Bridge.bundle.js` ã¯ã“ã®å¾Œã™ãã«ä½¿ã„ã¾ã™

# Swift ã‹ã‚‰å‘¼ã³å‡ºã™æº–å‚™

## JS ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 

å…ˆã»ã©ä½œã£ãŸ `Bridge.bundle.js` ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã—ã¾ã™

![](/images/1e4316e3f632b6/bundle-js.png =300x)

![](/images/1e4316e3f632b6/add-bundle-js.png =540x)
_`Copy items if needed` ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œå¿˜ã‚Œãªã„ã‚ˆã†ã«_

## JavaScriptCore

JavaScriptCore ã‚’ä½¿ã†ãŸã‚ã«ã¯ã€`JSVirtualMachine` ã¨ `JSContext` ãŒå¿…è¦ã§ã™
`JSVirtualMachine` ã¯ JS ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ä»®æƒ³ç’°å¢ƒã§ã€`JSContext` ã¯ãã®ä»®æƒ³ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹ JS ã¨ã®ã‚„ã‚Šã¨ã‚Šã‚’ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™

JSContext ã¯ä¸€åº¦ç”Ÿæˆã—ãŸã‚‰ä½¿ã„ã¾ã‚ã—ãŸã„ã®ã§ã€æ–°ãŸã«ã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ãã“ã§ç®¡ç†ã™ã‚‹ã“ã¨ã«ã—ã¾ã™

æ–°ãŸã« `JSBridge.swift` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ã¾ãšã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™

```swift:JSBridge.swift
import SwiftUI
import JavaScriptCore

class JSBridge: ObservableObject {

    private let vm = JSVirtualMachine()
    private let context: JSContext

    init() {
        let js = loadJSFile(fileName: "Bridge.bundle") // æ‹¡å¼µå­jsã¯ã‚ã¨ã§ã¤ã‘ã‚‹ã®ã§å«ã‚ãªã„(swiftã¡ã‚‡ã£ã¨ã‚­ãƒ¢ã„)

        self.context = JSContext(virtualMachine: self.vm)

        self.context.evaluateScript(js)
    }

}

private func loadJSFile(fileName: String) -> String? {
    // JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‹ã¯æ°—ã«ã—ãªãã¦ã„ã„
    let text = try? String(contentsOf: Bundle.main.url(forResource: fileName, withExtension: "js")!)

    return text
}

```

`loadJSFile()` ã§ `Bridge.bundle.js` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
ãã—ã¦ã€ä»®æƒ³ç’°å¢ƒã® `JSContext` ã‚’ä½œæˆã—ã€èª­ã¿è¾¼ã‚“ã  JS ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™

JS ã§æ›¸ã„ãŸ `Bridge` ã‚¯ãƒ©ã‚¹ã® `sum()` ã‚’å‘¼ã³å‡ºã™ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™

```swift:JSBridge.swift
func calcSum(numbers: [Int]) -> Int {
    var sum = 0
    let module = self.context.objectForKeyedSubscript("Bridge") // webpack.config.jsã§æŒ‡å®šã—ãŸã‚‚ã®
    let bridge = module?.objectForKeyedSubscript("Bridge") // è‡ªåˆ†ã§æ›¸ã„ãŸã‚¯ãƒ©ã‚¹å

    // Bridgeã‚¯ãƒ©ã‚¹ã®sumã¨ã„ã†é–¢æ•°ã‚’å‘¼ã³å‡ºã™
    // å¼•æ•°ã«numbersã‚’æ¸¡ã™
    if let result = bridge?.objectForKeyedSubscript("sum").call(withArguments: [numbers]) {
        // JSValueã‹ã‚‰Int32ã«å¤‰æ›ã—ã¦ã€Intã«ã™ã‚‹
        sum = Int(result.toInt32())
    }

    // å®Œäº†
    return sum
}
```

`context.objectForKeyedSubscript()` ã‚’ä½¿ã£ã¦ã€JS ã®ã‚¯ãƒ©ã‚¹ã‚„å¤‰æ•°ã€é–¢æ•°ãªã©ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
`this` ã‚’å–å¾—ã—ãŸã‚Šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯å‰²æ„›ã—ã¾ã™

é–¢æ•°ã‚’å–å¾—ã—ãŸå ´åˆã¯ã€`call()` ã‚’ä½¿ã£ã¦å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã€ãã®éš›ã«å¼•æ•°ã‚’é…åˆ—ã§æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™

è¿”ã‚Šå€¤ã¯æˆåŠŸã—ãŸå ´åˆã¯ `JSValue` ã§ã™ãŒã€å¤±æ•—ã—ãŸå ´åˆã¯ `nil` ã§ã™

`JSValue` ã¯ JS ã®å€¤ã‚’è¡¨ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ãŒã€ãã®ã¾ã¾ã§ã¯æ‰±ã„ã¥ã‚‰ã„ã®ã§ã€`toInt32()` ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ `Int32` ãªã©ã«å¤‰æ›ã—ã¦ä½¿ã„ã¾ã™
ç›´æ¥ `Int` ã«å¤‰æ›ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã®ã§ã€ä¸€åº¦ `Int32` ã«ã—ã¦ã‹ã‚‰ `Int` ã«ã—ã¦ã¾ã™

ã¾ãŸã€ã“ã® `calcSum()` ã¯ `@escaping` ã‚’ä½¿ã‚ãªã„åŒæœŸé–¢æ•°ã«ãªã£ã¦ã„ã¾ã™ãŒã€ä»Šå›ã®å‡¦ç†ç¨‹åº¦ãªã‚‰ååˆ†é«˜é€Ÿã«å‡¦ç†ã§ãã‚‹ãŸã‚å¿…è¦ã‚ã‚Šã¾ã›ã‚“

# å®Ÿè¡Œ

## UI

ã¾ãšã¯ã‚µã‚¯ãƒƒã¨ UI ã‚’ä½œã‚Šã¾ã™
æœ¬ç­‹ã§ã¯ãªã„ã®ã§ãã®ã¾ã¾ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¾ã™

```swift:ContentView.swift
struct ContentView: View {

    @ObservedObject var bridge = JSBridge()

    @State var numbers: [Int] = []
    @State var sum: Int = 0

    var body: some View {
        VStack(spacing: 20) {

            Button {
                generateRandomNums()
            } label: {
                Text("ç”Ÿæˆ")
            }

            HStack {
                ForEach(numbers, id: \.self) { num in
                    Text("\(num)")
                }
            }
            .frame(minHeight: 40)

            Button {

                calcSum()

            } label: {
                Text("è¨ˆç®—")
            }

            Text("åˆè¨ˆ: \(sum)")

        }
    }

    func generateRandomNums() {

        numbers = []

        (0..<Int.random(in: 1..<10)).forEach { num in
            numbers.append(Int.random(in: 1..<10))
        }

    }

    func calcSum() {
        self.sum = bridge.calcSum(numbers: numbers)
    }
}
```

`generateRandomNums` ã§ãƒ©ãƒ³ãƒ€ãƒ ã§æ•°å­—ã‚’ç”Ÿæˆã—ã€`calcSum` ã§ `JSBridge` ã® `calcSum` ã‚’å‘¼ã‚“ã§ã„ã¾ã™

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™

![](/images/1e4316e3f632b6/ui-1.png =700x)

![](/images/1e4316e3f632b6/capture-1.gif =440x)
_ã“ã‚Œã‚’æ’®å½±ã—ã¦ã„ãŸæ™‚ã§ã¯ `withAnimation` ã‚’ä½¿ã£ã¦ã„ãŸã®ã§è‹¥å¹²å‹•ããŒç•°ãªã‚Šã¾ã™_

ã¨ã‚Šã‚ãˆãš Swift ã‹ã‚‰ NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã—ãŸ

## JS å´ã‹ã‚‰ Swift ã‚’å‘¼ã³å‡ºã—ã¦ã¿ã‚‹

JS ã®æ–¹ã‹ã‚‰ Swift ã®é–¢æ•°ã‚’å‘¼ã‚“ã§ã¿ã¾ã™
ã¨è¨€ã£ã¦ã‚‚ã€è‡ªç”±ã«å‘¼ã¹ã‚‹ã¯ãšã‚‚ãªã„ã®ã§ã€JS å´ã§å®Ÿè¡Œã—ãŸã„ Swift ã‚’ VM ã«å·®ã—è¾¼ã‚€æ„Ÿã˜ã§ã™

`JSBridge` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™

```diff swift:JSBridge.swift
class JSBridge: ObservableObject {

    private let vm = JSVirtualMachine()
    private let context: JSContext

+    @Published var message = ""

    init() {
        let js = loadJSFile(fileName: "Bridge.bundle") // æ‹¡å¼µå­jsã¯ã‚ã¨ã§ã¤ã‘ã‚‹ã®ã§å«ã‚ãªã„(swiftã¡ã‚‡ã£ã¨ã‚­ãƒ¢ã„)

        self.context = JSContext(virtualMachine: self.vm)

        self.context.evaluateScript(js)

+        // é–¢æ•°ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆ
+        self.injectFunction()
    }

+    private func injectFunction() {
+        // JSå´ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹é–¢æ•°ã‚’ç™»éŒ²ã™ã‚‹
+        let sendMessage: @convention(block) (String) -> Void = { message in
+            DispatchQueue.main.async {
+                self.message = message
+                NSLog("Message from JS: \(message)")
+            }
+        }
+
+        // sendMessage ã¨ã„ã†åå‰ã§ç™»éŒ²
+        self.context.setObject(sendMessage, forKeyedSubscript: "sendMessage" as NSString)
+    }

    func calcSum(numbers: [Int]) -> Int {
        var sum = 0
        let module = self.context.objectForKeyedSubscript("Bridge") // webpack.config.jsã§æŒ‡å®šã—ãŸã‚‚ã®
        let bridge = module?.objectForKeyedSubscript("Bridge") // è‡ªåˆ†ã§æ›¸ã„ãŸã‚¯ãƒ©ã‚¹å

        // Bridgeã‚¯ãƒ©ã‚¹ã®sumã¨ã„ã†é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        // å¼•æ•°ã«numbersã‚’æ¸¡ã™
        if let result = bridge?.objectForKeyedSubscript("sum").call(withArguments: [numbers]) {
            // JSValueã‹ã‚‰Int32ã«å¤‰æ›ã—ã¦ã€Intã«ã™ã‚‹
            sum = Int(result.toInt32())
        }

        // å®Œäº†
        return sum
    }

}
```

`injectFunction()` å†…ã§å®šç¾©ã—ã¦ã„ã‚‹ `sendMessage` ã§ã¯ã€æ¸¡ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ `message` ã«ä»£å…¥ã—ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¾ã™
ã“ã‚Œã‚’ `sendMessage` ã¨ã„ã†åå‰ã§ VM ã«ç™»éŒ²ã—ã¦ã„ã¾ã™

JS å´ã§å‘¼ã³å‡ºã™ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™

```diff js:index.js
import * as lodash from "lodash"

export class Bridge {
    static sum(array) {
+        // ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹æ¤œè¨¼
+        if (typeof sendMessage === "function") {
+            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
+            sendMessage("Hello from JS!")
+        }

        return lodash.sum(array)
    }
}
```

ä¸€å¿œ `sendMessage` ãŒã¡ã‚ƒã‚“ã¨é–¢æ•°ã‹ã©ã†ã‹ç¢ºã‹ã‚ã¦ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã„ã¾ã™

ã“ã‚Œä»¥é™ã¯ `sum()` ã‚’å‘¼ã³å‡ºã™ãŸã³ã« `sendMessage` ã‚‚å‘¼ã³å‡ºã•ã‚Œã‚‹ã¯ãšã§ã™

## UI å´ã®ä¿®æ­£

`JSBridge` ã® `message` ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã« `ContentView` ã‚’å°‘ã—ä¿®æ­£ã—ã¾ã™

```diff swift:ContentView.swift
struct ContentView: View {

    @ObservedObject var bridge = JSBridge()

    @State var numbers: [Int] = []
    @State var sum: Int = 0

    var body: some View {
        VStack(spacing: 20) {

            Button {
                generateRandomNums()
            } label: {
                Text("ç”Ÿæˆ")
            }

            HStack {
                ForEach(numbers, id: \.self) { num in
                    Text("\(num)")
                }
            }
            .frame(minHeight: 40)

            Button {

                calcSum()

            } label: {
                Text("è¨ˆç®—")
            }

            Text("åˆè¨ˆ: \(sum)")

+            Text("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \(bridge.message)")

        }
    }

    func generateRandomNums() {

        numbers = []

        (0..<Int.random(in: 1..<10)).forEach { num in
            numbers.append(Int.random(in: 1..<10))
        }

    }

    func calcSum() {
        self.sum = bridge.calcSum(numbers: numbers)
    }
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€

![](/images/1e4316e3f632b6/capture-2.gif =440x)

ã¡ã‚ƒã‚“ã¨ JS ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¸¡ã•ã‚ŒãŸã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸ

`NSLog` ã§å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ä½¿ã„ã¾ã™ã€‚(`/System/Applications/Utilities/Console.app`)

![](/images/1e4316e3f632b6/console-1.png =700x)
_æ¤œç´¢æ¬„ã§ãƒ—ãƒ­ã‚»ã‚¹å(ä»Šå›ã¯ JSBridge)ã§æ¤œç´¢_

![](/images/1e4316e3f632b6/console-2.png =700x)

ã—ã£ã‹ã‚Šã¨ãƒ­ã‚°ã«ã‚‚å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™

# å®Ÿè¡Œé€Ÿåº¦

å…ˆã»ã©ã€ã“ã®ç¨‹åº¦ã®å‡¦ç†ãªã‚‰ååˆ†é«˜é€Ÿã ã¨è¨€ã„ã¾ã—ãŸãŒã€ã©ã‚Œãã‚‰ã„é«˜é€Ÿãªã®ã‹è»½ãèª¿ã¹ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã™

UI å´ã§ `bridge.calcSum` ã‚’å‘¼ã³å‡ºã™ã®ã«ã‹ã‹ã£ãŸæ™‚é–“ã‚’èª¿ã¹ã¦ã¿ã¾ã™

```diff swift:ContentView.swift
struct ContentView: View {

    @ObservedObject var bridge = JSBridge()

    @State var numbers: [Int] = []
    @State var sum: Int = 0

+    @State var time: String = "-"

    var body: some View {
        VStack(spacing: 20) {

            Button {
                generateRandomNums()
            } label: {
                Text("ç”Ÿæˆ")
            }

            HStack {
                ForEach(numbers, id: \.self) { num in
                    Text("\(num)")
                }
            }
            .frame(minHeight: 40)

            Button {

                calcSum()

            } label: {
                Text("è¨ˆç®—")
            }

            Text("åˆè¨ˆ: \(sum)")

            Text("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \(bridge.message)")

+            Text("å®Ÿè¡Œæ™‚é–“: \(time) ms")

        }
    }

    func generateRandomNums() {

        numbers = []

        (0..<Int.random(in: 1..<10)).forEach { num in
            numbers.append(Int.random(in: 1..<10))
        }

    }

    func calcSum() {
+        let startTime = Date()
+
        self.sum = bridge.calcSum(numbers: numbers)
+
+        let endTime = Date()
+
+        let timeElapsed = endTime.timeIntervalSince(startTime)
+
+        time = String(floor(Double(timeElapsed * 100000)) / 100)
    }
}
```

`timeIntervalSince` ã§è¿”ã‚‹ `TimeInterval` å‹ã¯ç§’æ•°ã‚’è¡¨ã™å‹ã§ã™ãŒã€ãã®ã¾ã¾è¡¨ç¤ºã•ã›ã‚‹ã¨ã‚ã¡ã‚ƒãã¡ã‚ƒé•·ã„å°æ•°ã«ãªã‚‹ã®ã§ã€å°æ•°ç¬¬ 2 ä½ã¾ã§ã®ãƒŸãƒªç§’ã«å¤‰æ›ã—ã¦ã„ã¾ã™

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã“ã®ã‚ˆã†ãªæ„Ÿã˜

![](/images/1e4316e3f632b6/capture-3.gif =600x)

æœ€åˆã®å®Ÿè¡Œã ã‘ 1ã€œ2ms ã‹ã‹ã£ã¦ã„ã¾ã™ãŒã€ãã®ã‚ã¨ã¯ 1ms æœªæº€ã®å®Ÿè¡Œæ™‚é–“ã¨ãªã£ã¦ã„ã¾ã™ã€‚(JS å´ã§å¤§ã—ãŸå‡¦ç†ã‚’ã‚„ã£ã¦ãªã„ã¨ã„ã†ã®ã‚‚ã‚ã‚‹ã¨ã¯æ€ã„ã¾ã™ãŒ)

ãã¡ã‚“ã¨ã—ãŸè¨ˆæ¸¬æ–¹æ³•ã§ã¯ãªã„ã¨ã¯æ€ã†ã®ã§ã€ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¨ã‹ã«ã¯ãªã‚‰ãªã„ã§ã—ã‚‡ã†ãŒã€æ™®é€šã«ä½¿ã†åˆ†ã«ã¯ååˆ†ãã‚‰ã„é«˜é€Ÿã ã¨æ€ã„ã¾ã™

# ã¾ã¨ã‚

JavaScriptCore ã‚’ä½¿ã†ã¨ Swift ã‹ã‚‰ JS ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚Šå‘¼ã³å‡ºã—ãŸã‚Šã€é€†ã« JS ã‹ã‚‰ Swift ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚‚ã§ãã¾ã™

Webpack ã‚’ä½¿ã£ã¦ JS ã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ã“ã¨ã§ã€NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ Swift ã§ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

ãƒã‚¤ãƒ†ã‚£ãƒ–ã® iOS ã‚„ macOS ã‚¢ãƒ—ãƒªä¸Šã§å‹•ã‹ã™ã“ã¨ãŒã§ãã‚‹ã®ãŒå¼·ã„ã¨æ€ã„ã¾ã™

## ä»Šå›ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰

https://github.com/p1atdev/JSBridge
