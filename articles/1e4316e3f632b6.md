---
title: "NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ Swift ã‹ã‚‰å‘¼ã³å‡ºã™"
emoji: "ğŸ§µ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["swift", "npm", "javascript", "javascriptcore"]
published: false
---

JavaScriptCore ã¨ã„ã†ã‚‚ã®ã‚’ã”å­˜çŸ¥ã§ã—ã‚‡ã†ã‹ï¼Ÿ

JavaScriptCore ã¯ ç´”æ­£ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ ã“ã‚Œã‚’ä½¿ã†ã¨ Swift ã‚„ Objective-C ã‹ã‚‰ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
ã‚‚ã¡ã‚ã‚“ã€iOS ã‚¢ãƒ—ãƒªã‹ã‚‰ã§ã‚‚å®Ÿè¡Œã§ãã¾ã™

è©³ç´°: [JavaScriptCore | Apple Developer Documentation](https://developer.apple.com/documentation/javascriptcore)

Swift ã‹ã‚‰ JavaScript ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ WKWebView ã‚’ä½¿ã†ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ Web ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ç­‰ã¯ç›®çš„ã¨ã—ã¦ã„ãªã„ãŸã‚ã€JavaScriptCore ã‚’åˆ©ç”¨ã—ã¾ã™

## ãã‚‚ãã‚‚ãªãœ Swift ã‹ã‚‰ JavaScript ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ã®ã‹ï¼Ÿ

ä¸€ç•ªå¤§ããªç†ç”±ã¯ã‚„ã¯ã‚Šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é‡ã®å·®ã§ã™ã€‚JS ã¨ Swift ã‚’æ¯”è¼ƒã™ã‚‹ã¨ã€åˆ©ç”¨è€…ã‚‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚åœ§å€’çš„ã« JS ã®æ–¹ãŒå¤šã„ã§ã™ã€‚
ãã®ãŸã‚ã€ç‰¹å®šã®ã“ã¨ã‚’ã—ãŸã„ã¨ã„ã†ã¨ãã«ã€Swift ã ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãªã„ãŸã‚è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€JS ã§ã‚ã‚Œã°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚‹ã€ã¨ã„ã†çŠ¶æ³ãŒãŸã¾ã«ç™ºç”Ÿã—ã¾ã™

ãã“ã§ã€JS ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ Swift ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã†ã“ã¨ãŒã§ãã‚Œã°å®Ÿè£…ã®æ‰‹é–“ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™

# å®Ÿè£…

æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰
https://github.com/p1atdev/JSBridge

:::details ç­†è€…ã®ç’°å¢ƒ

macOS Ventura 13.0 Beta
Xcode 14.0.0. beta
Node 16.13.1
Yarn 1.22.19

:::

## Swift ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

Xcode ã‹ã‚‰æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™

![](/images/1e4316e3f632b6/new-project.png =500x)

ä»Šå›ã¯ Multiplatform ã® App ã‚’é¸æŠã—ã¾ã—ãŸãŒåˆ¥ã«ã©ã‚Œã§ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¾ã™

![](/images/1e4316e3f632b6/project-naming.png =640x)

`JSBridge` ã¨ã„ã†åå‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ

![](/images/1e4316e3f632b6/initial-swiftui.png =640x)

SwiftUI ã‚¢ãƒ—ãƒªã®åˆæœŸçŠ¶æ…‹ã§ã™

## JS ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

JS ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™
ä»Šå›ã¯ã€å…ˆã»ã©ä½œæˆã—ãŸ `JSBridge` ãƒ•ã‚©ãƒ«ãƒ€ã®ç›´ä¸‹ã« `JS` ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ

![](/images/1e4316e3f632b6/directory.png =400x)

ã“ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã¯ Xcode ã§ã¯ãªã VSCode ãªã©ã‚’ä½¿ã£ã¦ä½œæ¥­ã™ã‚‹ã¨è‰¯ã„ã§ã™

### `.gitignore` ã®è¨­å®š

å¾Œã€…`node_modules` ãƒ•ã‚©ãƒ«ãƒ€ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ã€å…ˆã«ãƒ«ãƒ¼ãƒˆã« `.gitignore` ã‚’ä½œæˆã—ã¦ãŠãã¾ã™

[gitignore.io](https://gitignore.io) ã§ç”Ÿæˆã™ã‚‹ã¨æ¥½ã§ã™

### init

`npm init -y` ã‚„ `yarn init -y` ãªã©ã‚’å®Ÿè¡Œã—ã¦ `package.json` ã‚’ç”Ÿæˆã—ã¾ã™

ä¾‹

```json:package.json
{
  "name": "bridge",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
}
```

### Webpack

JavaScriptCore ã§ã¯ã€JS ã‚³ãƒ¼ãƒ‰ã‚’æ–‡å­—åˆ—ã¨ã—ã¦å—ã‘å–ã£ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™
ãã®ãŸã‚ã€NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã¯ã€ä¸€ã¤ã®ã‚³ãƒ¼ãƒ‰ã«ã¾ã¨ã‚ã¦ã‚ã’ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™

ãã“ã§ä½¿ã†ã®ãŒã€ãŠé¦´æŸ“ã¿ã® webpack ã§ã™
Web ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã§ã¯ã»ã¼ webpack ãŒå‡ºã¦ãã¦ã€è¤‡æ•°ã® JS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ³ãƒ‰ãƒ«ã—ãŸã‚Šã—ã¦ã„ã¾ã™
ã“ã“ã§ã‚‚ã€Web ã¨åŒã˜ã‚ˆã†ã«ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ã“ã¨ãŒç›®çš„ãªã®ã§ã€ã„ã¤ã‚‚ã¨åŒã˜ã‚ˆã†ã«ä½¿ã†ã“ã¨ã§è§£æ±ºã§ãã¾ã™

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash:npm
npm install -D webpack webpack-cli
```

ã¾ãŸã¯

```bash:yarn
yarn add -D webpack webpack-cli
```

ãƒ“ãƒ«ãƒ‰ã«ã—ã‹ä½¿ç”¨ã—ãªã„ãŸã‚ã€`-D` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ã€ãƒ“ãƒ«ãƒ‰æ™‚ã« Webpack è‡ªèº«ã‚’å«ã‚ã¦ç”Ÿæˆã—ãªã„ã‚ˆã†ã«ã—ã¾ã™

#### è¨­å®š

`webpack.config.js` ã‚’ä½œæˆã—ã¾ã™
`webpack init` ã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†ã¨ã€ä½™è¨ˆãªã‚‚ã®ãŒå…¥ã£ã¦ãã‚‹ã®ã§è‡ªåˆ†ã§æ›¸ãã®ãŒãŠã™ã™ã‚ã§ã™

ã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã™

```js:webpack.config.js
var path = require("path")

module.exports = {
    entry: { Bridge: "./index.js" }, // ã“ã® `Bridge` ã¨ã„ã†åå‰ã¯è‡ªç”±ã«å¤‰ãˆã¦ã‚‚è‰¯ã„ã‘ã©ã‚ã¨ã§ä½¿ã†ã®ã§å¿˜ã‚Œãªã„ã‚ˆã†ã«
    output: {
        path: path.resolve(__dirname, "dist"),
        filename: "[name].bundle.js",
        library: "[name]",
        libraryTarget: "var",
    },
}
```

`package.json` ã®æ–¹ã«ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½è¨˜ã—ã¾ã™

```json:package.json
{
  "name": "bridge",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "dependencies": {
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "webpack": "^5.73.0",
    "webpack-cli": "^4.10.0"
  },
  "scripts": {
    "build": "webpack --progress --color"
  }
}
```

`build` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å„è‡ªè¦‹ã‚„ã™ã„ã‚ˆã†ã«å¤‰ãˆã¦è‰¯ã„ã¨æ€ã„ã¾ã™

ã“ã‚Œã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã§ã™

### ä½¿ã„ãŸã„ NPM ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

å„è‡ªã®ä½¿ã„ãŸã„ NPM ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

ãªã‚“ã§ã‚‚è‰¯ã„ã®ã§ã™ãŒã€ä»Šå›ã¯ `lodash` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸ
(å®Ÿéš›ã¯ã‚ã–ã‚ã– Swift ã‹ã‚‰ `lodash` ã‚’å‘¼ã³å‡ºã—ã¦ä½¿ã†ä¾¡å€¤ãªã‚“ã¦ãªã„ã§ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã†ã®ã§)

`lodash` ã¯ JS ç”¨ã®ä¾¿åˆ©é–¢æ•°è©°ã‚åˆã‚ã›ãƒ‘ãƒƒã‚¯ã¿ãŸã„ãªã‚‚ã®ã§ã™
`loadash` ã§ã¯ãªã„ã®ã§æ³¨æ„(ä¸€æ•—)

https://lodash.com/

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

```bash:npm
npm install lodash
```

ã¾ãŸã¯

```bash:yarn
yarn add lodash
```

ä»Šå›ã¯ `-D` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã¤ã‘ã¾ã›ã‚“

### å®Ÿè£…

`index.js` ã‚’ä½œæˆã—ã€ã¾ãšã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã™
(ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€`webpack.config.js` ã§åˆã‚ã›ã‚Œã°ãªã‚“ã§ã‚‚ã„ã„ã¨æ€ã†)

```js:index.js
import * as lodash from "lodash"

// ã“ã®ã‚¯ãƒ©ã‚¹åã‚‚ã‚ã¨ã§ä½¿ã†ã“ã¨ã«ãªã‚‹
export class Bridge {
    // lodash ã®æ•°å­—ã®é…åˆ—ã®å’Œã‚’è¿”ã™é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—
    static sum(array) {
        return lodash.sum(array)
    }
}
```

ã‚³ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã€`Bridge` ã‚¯ãƒ©ã‚¹ã® `sum` ã¨ã„ã†é–¢æ•°ã§ `lodash` ã® `sum` ã‚’ãƒ©ãƒƒãƒ—ã—ã¦å‘¼ã³å‡ºã—ã¦ã„ã¾ã™

### ãƒãƒ³ãƒ‰ãƒ«

Webpack ã§ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã¾ã™

```bash:npm
npm run build
```

ã¾ãŸã¯

```bash:yarn
yarn build
```

ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`dist` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ–°ãŸã«ä½œæˆã•ã‚Œã€ä¸­ã« `Bridge.bundle.js` ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™

![](/images/1e4316e3f632b6/bundled.png =400x)

`Bridge.bundle.js` ã¯ã“ã®å¾Œã™ãã«ä½¿ã„ã¾ã™

## Swift ã‹ã‚‰å‘¼ã³å‡ºã™

JavaScriptCore ã¯ä¸€åº¦ç”Ÿæˆã—ãŸã‚‰ä½¿ã„ã¾ã‚ã—ãŸã„ã®ã§ã€æ–°ãŸã«ã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦ãã“ã§ç®¡ç†ã™ã‚‹ã“ã¨ã«ã—ã¾ã™

æ–°ãŸã« `JSBridge.swift` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™

```swift:JSBridge.swift
import SwiftUI
import JavaScriptCore

class JSBridge: ObservableObject {

    private let vm = JSVirtualMachine()
    private let context: JSContext

    @Published var message = ""

    init() {
        let js = JSBridge.loadJSFile(fileName: "Bridge.bundle") // æ‹¡å¼µå­jsã¯ã‚ã¨ã§ã¤ã‘ã‚‹ã®ã§å«ã‚ãªã„(swiftã¡ã‚‡ã£ã¨ã‚­ãƒ¢ã„)

        self.context = JSContext(virtualMachine: self.vm)

        self.context.evaluateScript(js)

        // é–¢æ•°ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆ
        self.injectFunction()
    }

    private static func loadJSFile(fileName: String) -> String? {
        // JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ã‹ã¯æ°—ã«ã—ãªãã¦ã„ã„
        let text = try? String(contentsOf: Bundle.main.url(forResource: fileName, withExtension: "js")!)

        return text
    }


    func calcSum(numbers: [Int], completion: @escaping (_ sum: Int) -> Void){
        DispatchQueue.global(qos: .userInitiated).async {

            var sum = 0
            let module = self.context.objectForKeyedSubscript("Bridge") // webpack.config.jsã§æŒ‡å®šã—ãŸã‚‚ã®
            let bridge = module?.objectForKeyedSubscript("Bridge") // ã‚¯ãƒ©ã‚¹å

            // Bridgeã‚¯ãƒ©ã‚¹ã®sumã¨ã„ã†é–¢æ•°ã‚’å‘¼ã³å‡ºã™
            // å¼•æ•°ã«numbersã‚’æ¸¡ã™
            if let result = bridge?.objectForKeyedSubscript("sum").call(withArguments: [numbers]) {
                // JSValueã‹ã‚‰Int32ã«å¤‰æ›ã—ã¦ã€Intã«ã™ã‚‹
                sum = Int(result.toInt32())
            }

            DispatchQueue.main.async {
                // å®Œäº†
                completion(sum)
            }
        }
    }

}
```

ã“ã‚Œã¯...ãªã‚“ã ã‚ã†
ã‚ˆãã‚ã‹ã‚‰ã‚“ã®ã§ã‚ã¨ã§ç¶šãã‹ã
