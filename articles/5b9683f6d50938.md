---
title: "ã€Swift5ã€‘ãƒ‡ãƒã‚¤ã‚¹ã‚’å›è»¢ã•ã›ã‚‹ã¨ã‚«ãƒ¡ãƒ©(AVCaptureVideoPreviewLayer)ã®å‘ããŒãŠã‹ã—ããªã‚‹ç¾è±¡ã®è§£æ±ºæ–¹æ³•"
emoji: "ğŸ¤³"
type: "tech"
topics: ["swift"]
published: true
---

# ä½•ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã®ã‹
`AVCaptureVideoPreviewLayer`ã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã†ã¨ã€ãƒ‡ãƒã‚¤ã‚¹ãŒå›è»¢ã—ãŸéš›ã€ã‚«ãƒ¡ãƒ©ãŒè¡¨ç¤ºã—ã¦ã„ã‚‹ã®ãŒãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã¨ä¸€è‡´ã—ãªã„ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯[Swiftã§ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹(1)](https://qiita.com/t_okkan/items/f2ba9b7009b49fc2e30a)ã«è¿½è¨˜ã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚

# å¯¾ç­–
# ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‘ã
## 1.ç”»é¢ã®å‘ãã‚’ç°¡å˜ã«è¡¨ã™enumã‚’ä½œæˆ
```swift: ViewController.swift
    /// ç”»é¢ã®å‘ã
    enum Orientaion: Int {
        /// ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã®ä½ç½®ãŒ
        case right = -1,
             down = 0,
             left = 1,
             up = 2
    }
```

## 2.ç”»é¢ã®å‘ãã‚’å–å¾—ã™ã‚‹é–¢æ•°
``` swift: ViewController.swift
/// ç”»é¢ã®å‘ãã‹ã‚‰ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
private func getDeviceOrientation() -> Orientaion {
    
    guard let interfaceOrientation = UIApplication.shared.windows.first(where: { $0.isKeyWindow })?.windowScene?.interfaceOrientation else {
        return .right
    }
    
    switch interfaceOrientation {
    case .landscapeLeft:
        return .left
    case .landscapeRight:
        return .right
    case .portrait:
        return .down
    case .portraitUpsideDown:
        return .up
        
    default:
        return .right
    }
    
}
```

## 3.ã‚«ãƒ¡ãƒ©ã®å‘ãã‚’ä¿®æ­£ã™ã‚‹é–¢æ•°
```swift: ViewController.swift
/// ã‚«ãƒ¡ãƒ©ã®å‘ãã‚’ä¿®æ­£ã™ã‚‹
private func fixCameraOrientation() {
    
    // ãƒ­ãƒ¼ãƒ‰æ™‚ã‹ã‚‰ã„ãã‚‰å›è»¢ã—ãŸã‹ã‚’å–å¾—
    let rotation: CGFloat = CGFloat(getDeviceOrientation().rawValue) * 90
    
    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã®ã§CATransform3DMakeRotationã‚’ä½¿ã£ã¦å›è»¢ã•ã›ã¾ã™
    self.cameraPreviewLayer?.transform = CATransform3DMakeRotation(
        rotation / 180 * CGFloat.pi,
        0,
        0,
        1
    )
    
    // å›è»¢ã—ã¦ã‚‚ãƒ•ãƒ¬ãƒ¼ãƒ ã¯å‰ã®ã¾ã¾ãªã®ã§ã€è¦ªãƒ“ãƒ¥ãƒ¼ã¨åˆã‚ã›ã¦ã‚ã’ã¾ã™
    cameraPreviewLayer?.frame = view.frame
}

/// ç”»é¢ã®å‘ãã«ã¤ã„ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
private func setUpOrientaion() {
    
    
    // é€šå¸¸ã®çŠ¶æ…‹ã¨ã®é•ã„ã®è§’åº¦ã‚’å–å¾—
    let rotation: CGFloat = {
        switch initialOrientation {
        case .down:
            return 0
            
        case .right:
            return -90
            
        case .up:
            return 180
            
        case .left:
            return 90
            
        }
        
    }()
    
    self.cameraPreviewLayer?.transform = CATransform3DMakeRotation(
        rotation / 180 * CGFloat.pi,
        0,
        0,
        1
    )
    
    // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’èª¿æ•´
    cameraPreviewLayer?.frame = view.frame

}
```

## 4.ç”»é¢ãƒ­ãƒ¼ãƒ‰æ™‚ã¨ç”»é¢å›è»¢æ™‚ã«ä¿®æ­£ã‚’ã™ã‚‹
```swift: ViewController.swift
override func viewDidLoad() {
    super.viewDidLoad()
    
    //ã‚«ãƒ¡ãƒ©ã®å‘ãã‚’è¨­å®š
    setUpOrientaion()
    
}

//ç”»é¢å›è»¢æ™‚ã®å‹•ä½œ
override func viewWillTransition(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator) {
    super.viewWillTransition(to: size, with: coordinator)
    coordinator.animate(
        alongsideTransition: { _ in
            
            //ã‚«ãƒ¡ãƒ©ã®å‘ãã‚’ä¿®æ­£
            self.fixCameraOrientation()
            
        }
    )
}
```
# å†™çœŸã®å‘ã
ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‘ãã¨ä¸€ç·’ã«ã€å†™çœŸã®å‘ãã‚‚ãŠã‹ã—ããªã‚‹ã®ã§ä¿®æ­£ã—ã¾ã™

```swift: ViewController.swift
//MARK: AVCapturePhotoCaptureDelegateãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰
extension ViewController: AVCapturePhotoCaptureDelegate {
    // æ’®å½±ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚ŒãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰
    func photoOutput(_ output: AVCapturePhotoOutput, didFinishProcessingPhoto photo: AVCapturePhoto, error: Error?) {
    
    //ç”»åƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€
        if let imageData = photo.fileDataRepresentation() {
            
            //ç”»åƒã®å‘ãã‚’åˆ¤å®šã—ã€ä¿®æ­£ã™ã‚‹å‘ãã‚’è¨­å®š
            let imageOrientation: UIImage.Orientation = {
                switch getDeviceOrientation(){

                case .down:
                    
                    return .right
                    
                case .right:
                    
                    return .up
                    
                case .left:
                    
                    return .down
                    
                case .up:
                    
                    return .left
                }
            }()

            //å‘ãã‚’è€ƒæ…®ã—ã¦ç”»åƒã«å¤‰æ›
            let image = UIImage(cgImage: UIImage(data: imageData)!.cgImage!,
                                scale: 1.0,
                                orientation: imageOrientation
            )!
	    
	    
	    //ã§ããŸç”»åƒã§è‰²ã€…ãªå‡¦ç†
	    doSomething(image)
	    
        }
    }
}
```
ã“ã‚Œã§æ’®ã£ãŸå†™çœŸã‚‚æ­£å¸¸ãªå‘ãã«ãªã‚Šã¾ã™ã€‚

# å®Œäº†
ä»¥ä¸Šã§ã€ã‚«ãƒ¡ãƒ©ã®è¡¨ç¤ºãŒãŠã‹ã—ããªã‚‹ã®ã¯ä¸€å¿œä¿®æ­£å‡ºãŸã¨æ€ã„ã¾ã™ãŒã€ç”»é¢å›è»¢æ™‚ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹•ããŒå°‘ã—æŒ™å‹•ä¸å¯©ãªã®ãŒæ°—ã«ãªã‚Šã¾ã™...
é–“é•ãˆã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã£ãŸã‚Šã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ã€‚

## å‚è€ƒæ–‡çŒ®
- Swiftã§ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹(1)
https://qiita.com/t_okkan/items/f2ba9b7009b49fc2e30a
ã‚«ãƒ¡ãƒ©ã®ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã®ã«ä½¿ã„ã¾ã—ãŸ

- iOSã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†æ–¹æ³•â€å›è»¢â€
https://www.indetail.co.jp/blog/ios-animation-rotation/
CATransform3DMakeRotationã®ä½¿ã„æ–¹

- CALayerã§3Dã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼Ÿ
https://terazzo.hatenadiary.org/entry/20111207/1323283155
åŒä¸Š